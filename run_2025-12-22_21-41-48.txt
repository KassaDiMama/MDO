    "---------------------------------"
    "---------------------------------"
    "Starting new run at 2025-12-22 21:41:48"

        function start(obj)
            
            
            objective = @(x) obj.objective_wrapper(x);
            nonlcon = @(x) obj.constraints(x);
            ub = [];
            ub(1) = 26/obj.x0(1); %b_outboard
            ub(2) = 40/180*pi/obj.x0(2);
            ub(3) = 0.85/obj.x0(3);
            ub(4) = 12/obj.x0(4);
            ub(5) = obj.initializer.AU_upper_bound;
            ub(6) = obj.initializer.AU_upper_bound;
            ub(7) = obj.initializer.AU_upper_bound;
            ub(8) = obj.initializer.AU_upper_bound;
            ub(9) = obj.initializer.AU_upper_bound;
            ub(10) = obj.initializer.AU_upper_bound;
            ub(11) = obj.initializer.AL_upper_bound;
            ub(12) = obj.initializer.AL_upper_bound;
            ub(13) = obj.initializer.AL_upper_bound;
            ub(14) = obj.initializer.AL_upper_bound;
            ub(15) = obj.initializer.AL_upper_bound;
            ub(16) = obj.initializer.AL_upper_bound;
            ub(17) = 0.88/obj.x0(17);
            ub(18) = 13075.92/obj.x0(18);

            
            lb(1) = 15/obj.x0(1);
            lb(2) = 0/obj.x0(2);
            lb(3) = 0.2/obj.x0(3);
            lb(4) = 6/obj.x0(4);
            lb(5) = obj.initializer.AU_lower_bound;
            lb(6) = obj.initializer.AU_lower_bound;
            lb(7) = obj.initializer.AU_lower_bound;
            lb(8) = obj.initializer.AU_lower_bound;
            lb(9) = obj.initializer.AU_lower_bound;
            lb(10) = obj.initializer.AU_lower_bound;
            lb(11) = obj.initializer.AL_lower_bound;
            lb(12) = obj.initializer.AL_lower_bound;
            lb(13) = obj.initializer.AL_lower_bound;
            lb(14) = obj.initializer.AL_lower_bound;
            lb(15) = obj.initializer.AL_lower_bound;
            lb(16) = obj.initializer.AL_lower_bound;
            lb(17) = 0.72/obj.x0(17);
            lb(18) = 10698.48/obj.x0(18);

   
            x0_normalized = obj.x0./obj.x0;
            

            A = [];
            b = [];
            Aeq = []; % Equality constraints
            beq = []; % Right-hand side for equality constraints

            % Options (recommended)
            options = optimoptions('fmincon', ...
            'Algorithm','sqp', ...
            'Display','iter-detailed', ...
            'MaxIterations',500, ...
            'MaxFunctionEvaluations',1e6, ...
            'FunctionTolerance',1e-6, ...
            'StepTolerance',1e-6, ...
            'OptimalityTolerance',1e-10, ...
            'DiffMinChange',1e-2, ...
            'DiffMaxChange',1e-1);

            disp(string(datetime('now')) + " | Starting optimization...");
22-Dec-2025 21:41:48 | Starting optimization...
            tic;
            
            [x_opt, fval, history, searchdir] = fmincon(objective, ...
                                          x0_normalized, A, b, Aeq, beq,lb ,ub , ...
                                          nonlcon, options);
        function objective = objective_wrapper(obj,x_normalized)
            x=x_normalized.*obj.x0;
            obj.dvec = obj.dvec.fromVector(x);
            obj.wingDesign = obj.wingDesign.fromDesignVector(obj.dvec);
            obj.mda.wingDesign = obj.wingDesign;
            % obj.dvec = DesignVector().fromVector(x);
            % obj.wingDesign = WingDesign(obj.dvec);
            % obj.mda.wingDesign = obj.wingDesign;
            range = obj.objective_loop();
        function objective = objective_loop(obj)
            lol =obj.mda.MDA_loop(obj.mda.W_TO_max,obj.wingDesign.W_fuel,obj.mda.W_ZF,obj.initializer.W_AminusW_initial,obj.initializer.V_MO_initial);

        function obj= MDA_loop(obj,W_TO_max,W_fuel,W_ZF,W_AminusW_initial,V_MO_initial)
            
            W_init = W_TO_max;
            obj.W_TO_max = W_TO_max;
            % obj.W_fuel = W_fuel;
            obj.W_ZF = W_ZF;
            
            [lift_dist, moment_dist] = obj.loadsFunc(W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            W_wing = obj.structuresFunc(lift_dist, moment_dist, W_TO_max, W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            obj.W_TO_max = W_AminusW_initial+W_wing+obj.wingDesign.W_fuel;
            obj.W_ZF = W_AminusW_initial+W_wing;

            W_TO_old = 0;
            while abs(obj.W_TO_max - W_TO_old) > W_TO_old * 0.01
    
                % Store the current assumed weight before iteration for the convergence check
                W_TO_old = obj.W_TO_max;
                
                % Perform one step of the Newton-Raphson iteration to get a better estimate
                % The 'newton' function already calculates W_TO_calculated for the assumed W_TO_max.
                new_W_TO = obj.newton(W_AminusW_initial,V_MO_initial);
        
        function new_W = newton(obj,W_AminusW_initial,V_MO_initial)
            [lift_dist, moment_dist] = obj.loadsFunc(obj.W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            
            % [W_TO_calc, W_ZF_calc] = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
            W_fuel_calc = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_calc = W_AminusW_initial+W_fuel_calc+obj.wingDesign.W_fuel;
            W_ZF_calc = W_AminusW_initial+W_fuel_calc;
            f_x = obj.W_TO_max - W_TO_calc;
    
           
            d_W_calc_d_W = obj.W_TO_max_prime(W_AminusW_initial,V_MO_initial);
        function derivative =  W_TO_max_prime(obj, W_AminusW_initial,V_MO_initial)
            delta_W = 1;
            W_TO_plus = obj.W_TO_max+delta_W;
            [lift_distribution_plus, moment_distribution_plus] = obj.loadsFunc(W_TO_plus,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            W_wing_plus = obj.structuresFunc(lift_distribution_plus, moment_distribution_plus, W_TO_plus, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_max_plus = W_AminusW_initial+W_wing_plus+obj.wingDesign.W_fuel;
            
            % [W_TO_max_plus, ~] = obj.structuresFunc(lift_distribution_plus, moment_distribution_plus, W_TO_plus, obj.W_ZF);
            derivative = (W_TO_max_plus - obj.W_TO_max) / delta_W;
        end
        
            f_prime_x = 1 - d_W_calc_d_W;
        
            if abs(f_prime_x) > 1e-6 % Check for near-zero derivative
                new_W = obj.W_TO_max - (f_x / f_prime_x);
            end
        end
                
                % Update the assumed weight (W_TO_max) with the new, calculated value for the next iteration
                [new_lift_dist, new_moment_dist] = obj.loadsFunc(new_W_TO,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
                % [new_W_TO, new_ZF] = obj.structuresFunc(new_lift_dist, new_moment_dist, W_TO_max, W_ZF);
                new_W_wing = obj.structuresFunc(new_lift_dist, new_moment_dist, W_TO_max, W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
                new_W_TO = W_AminusW_initial+new_W_wing+obj.wingDesign.W_fuel;
                new_ZF = W_AminusW_initial+new_W_wing;
                
                obj.W_TO_max = new_W_TO;
                obj.W_ZF = new_ZF;
                % Optional: display the iteration progress
                % fprintf('Iteration: W_TO_assumed = %.2f, W_TO_new = %.2f, Difference = %.2f\n', W_TO_old, new_W_TO, abs(W_TO_old - new_W_TO));
            end
            [lift_dist, moment_dist] = obj.loadsFunc(obj.W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            % [W_TO_final, W_ZF_final] = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
            W_wing_final = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_final = W_AminusW_initial+W_wing_final+obj.wingDesign.W_fuel;
            W_ZF_final = W_AminusW_initial+W_wing_final;
            obj.W_TO_max = W_TO_final;
            obj.W_ZF = W_ZF_final;
            % fprintf('Finished Iterating: W_TO_initial = %.2f, W_TO_final = %.2f, Difference = %.2f\n', W_init, W_TO_final, abs(W_init - W_TO_final));

        end
            LD_cr = obj.aerodynamicsFunc(obj.mda.W_TO_max,obj.wingDesign.W_fuel);

        function [LD_cruise] = aerodynamicsFunc(obj,W_TO_max,W_fuel)
            [CL_wing, CD_wing] = obj.calcCL_CD(W_TO_max,W_fuel);
        function [CL_wing,CD_wing] = calcCL_CD(obj,W_TO_max,W_fuel)
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 1;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 30;
            % Flight Condition
            AC.Aero.V     = obj.wingDesign.V;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = obj.wingDesign.Re;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = obj.wingDesign.Mcr;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_cruise(W_TO_max,W_fuel);          % lift coefficient - comment this line to run the code for given alpha%
            % logMessage([string(datetime('now')) + " | AC details: " + jsonencode(AC)], "log.file");

            Res = Q3D_solver(AC);
            CL_wing = Res.CLwing;
            CD_wing = Res.CDwing;
            if isnan(CD_wing)
            end
            % logMessage([string(datetime('now')) + " | AC details: " + jsonencode(AC) + " | CL: " + string(CL_wing) + " | CD: " + string(CD_wing)], "log.file");
            % disp("CL_wing = " + string(CL_wing) + ", CD_wing = " + string(CD_wing));
            

        end

            q=obj.calculateDesignDynamicPressure();
        function q = calculateDesignDynamicPressure(obj)
            q=0.5*obj.wingDesign.rho*obj.wingDesign.V^2;
        end
            drag = CD_wing * q *obj.wingDesign.S + obj.initializer.drag_fus_initial/obj.initializer.q_design_initial * q;
            lift = CL_wing * q *obj.wingDesign.S;
            
            LD_cruise = lift/drag;

        end
            eta = obj.performanceFunction();
        function eta = performanceFunction(obj)
            A = (obj.wingDesign.V-obj.initializer.V_cr_ref_initial)^2/(2*70^2);
            B = (obj.wingDesign.hcr - Const.hcr_ref)^2/(2*2500^2);
            eta = exp(-A-B);
            
        end
            objective = obj.objectiveFunc(obj.wingDesign.W_fuel, obj.mda.W_TO_max, LD_cr, eta);
        function objective = objectiveFunc(obj,W_fuel, W_TO_max, LD_cr, eta)
            W_cr_ratio = 1/((W_fuel/W_TO_max-1)/-0.9938);
            CT = Const.CT_bar/eta;
            R = obj.wingDesign.V /CT *LD_cr *log(W_cr_ratio);
            objective = R;
            msg = [
                "Ran objective function that resulted in range = " + string(R)
                "With designVector:"
                obj.dvec.toString()  % column string array
            ];
            
            % logMessage(msg, "log.file");
        end
                     

        end
            logmsg("--------------------------------");
            logmsg("At " + string(datetime('now')) + ...
                " calculated range: " + string(range/1000) + " km");
            logmsg("With wing design:");
            logmsg(obj.wingDesign.toString());
            logmsg("--------------------------------");
            objective = -(range/obj.initializer.range_initial);
        end
        function [c,ceq] = constraints(obj,x_normalized)
            x=x_normalized.*obj.x0;
            obj.dvec = obj.dvec.fromVector(x);
            obj.wingDesign = obj.wingDesign.fromDesignVector(obj.dvec);
            obj.mda.wingDesign = obj.wingDesign;

            
            % No inequality constraints
            lol =obj.mda.MDA_loop(obj.mda.W_TO_max,obj.wingDesign.W_fuel,obj.mda.W_ZF,obj.initializer.W_AminusW_initial,obj.initializer.V_MO_initial);

        function obj= MDA_loop(obj,W_TO_max,W_fuel,W_ZF,W_AminusW_initial,V_MO_initial)
            
            W_init = W_TO_max;
            obj.W_TO_max = W_TO_max;
            % obj.W_fuel = W_fuel;
            obj.W_ZF = W_ZF;
            
            [lift_dist, moment_dist] = obj.loadsFunc(W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            W_wing = obj.structuresFunc(lift_dist, moment_dist, W_TO_max, W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            obj.W_TO_max = W_AminusW_initial+W_wing+obj.wingDesign.W_fuel;
            obj.W_ZF = W_AminusW_initial+W_wing;

            W_TO_old = 0;
            while abs(obj.W_TO_max - W_TO_old) > W_TO_old * 0.01
    
                % Store the current assumed weight before iteration for the convergence check
                W_TO_old = obj.W_TO_max;
                
                % Perform one step of the Newton-Raphson iteration to get a better estimate
                % The 'newton' function already calculates W_TO_calculated for the assumed W_TO_max.
                new_W_TO = obj.newton(W_AminusW_initial,V_MO_initial);
        
        function new_W = newton(obj,W_AminusW_initial,V_MO_initial)
            [lift_dist, moment_dist] = obj.loadsFunc(obj.W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            
            % [W_TO_calc, W_ZF_calc] = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
            W_fuel_calc = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_calc = W_AminusW_initial+W_fuel_calc+obj.wingDesign.W_fuel;
            W_ZF_calc = W_AminusW_initial+W_fuel_calc;
            f_x = obj.W_TO_max - W_TO_calc;
    
           
            d_W_calc_d_W = obj.W_TO_max_prime(W_AminusW_initial,V_MO_initial);
        function derivative =  W_TO_max_prime(obj, W_AminusW_initial,V_MO_initial)
            delta_W = 1;
            W_TO_plus = obj.W_TO_max+delta_W;
            [lift_distribution_plus, moment_distribution_plus] = obj.loadsFunc(W_TO_plus,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            W_wing_plus = obj.structuresFunc(lift_distribution_plus, moment_distribution_plus, W_TO_plus, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_max_plus = W_AminusW_initial+W_wing_plus+obj.wingDesign.W_fuel;
            
            % [W_TO_max_plus, ~] = obj.structuresFunc(lift_distribution_plus, moment_distribution_plus, W_TO_plus, obj.W_ZF);
            derivative = (W_TO_max_plus - obj.W_TO_max) / delta_W;
        end
        
            f_prime_x = 1 - d_W_calc_d_W;
        
            if abs(f_prime_x) > 1e-6 % Check for near-zero derivative
                new_W = obj.W_TO_max - (f_x / f_prime_x);
            end
        end
                
                % Update the assumed weight (W_TO_max) with the new, calculated value for the next iteration
                [new_lift_dist, new_moment_dist] = obj.loadsFunc(new_W_TO,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
                % [new_W_TO, new_ZF] = obj.structuresFunc(new_lift_dist, new_moment_dist, W_TO_max, W_ZF);
                new_W_wing = obj.structuresFunc(new_lift_dist, new_moment_dist, W_TO_max, W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
                new_W_TO = W_AminusW_initial+new_W_wing+obj.wingDesign.W_fuel;
                new_ZF = W_AminusW_initial+new_W_wing;
                
                obj.W_TO_max = new_W_TO;
                obj.W_ZF = new_ZF;
                % Optional: display the iteration progress
                % fprintf('Iteration: W_TO_assumed = %.2f, W_TO_new = %.2f, Difference = %.2f\n', W_TO_old, new_W_TO, abs(W_TO_old - new_W_TO));
            end
            [lift_dist, moment_dist] = obj.loadsFunc(obj.W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            % [W_TO_final, W_ZF_final] = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
            W_wing_final = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_final = W_AminusW_initial+W_wing_final+obj.wingDesign.W_fuel;
            W_ZF_final = W_AminusW_initial+W_wing_final;
            obj.W_TO_max = W_TO_final;
            obj.W_ZF = W_ZF_final;
            % fprintf('Finished Iterating: W_TO_initial = %.2f, W_TO_final = %.2f, Difference = %.2f\n', W_init, W_TO_final, abs(W_init - W_TO_final));

        end
            c(1) = obj.mda.W_TO_max/obj.wingDesign.S  - Const.W_TO_max_initial/obj.initializer.S_initial; % Wing loading constraint  
            ceq = [];
        end
    end
end
        function objective = objective_wrapper(obj,x_normalized)
            x=x_normalized.*obj.x0;
            obj.dvec = obj.dvec.fromVector(x);
            obj.wingDesign = obj.wingDesign.fromDesignVector(obj.dvec);
            obj.mda.wingDesign = obj.wingDesign;
            % obj.dvec = DesignVector().fromVector(x);
            % obj.wingDesign = WingDesign(obj.dvec);
            % obj.mda.wingDesign = obj.wingDesign;
            range = obj.objective_loop();
        function objective = objective_loop(obj)
            lol =obj.mda.MDA_loop(obj.mda.W_TO_max,obj.wingDesign.W_fuel,obj.mda.W_ZF,obj.initializer.W_AminusW_initial,obj.initializer.V_MO_initial);

        function obj= MDA_loop(obj,W_TO_max,W_fuel,W_ZF,W_AminusW_initial,V_MO_initial)
            
            W_init = W_TO_max;
            obj.W_TO_max = W_TO_max;
            % obj.W_fuel = W_fuel;
            obj.W_ZF = W_ZF;
            
            [lift_dist, moment_dist] = obj.loadsFunc(W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            W_wing = obj.structuresFunc(lift_dist, moment_dist, W_TO_max, W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            obj.W_TO_max = W_AminusW_initial+W_wing+obj.wingDesign.W_fuel;
            obj.W_ZF = W_AminusW_initial+W_wing;

            W_TO_old = 0;
            while abs(obj.W_TO_max - W_TO_old) > W_TO_old * 0.01
    
                % Store the current assumed weight before iteration for the convergence check
                W_TO_old = obj.W_TO_max;
                
                % Perform one step of the Newton-Raphson iteration to get a better estimate
                % The 'newton' function already calculates W_TO_calculated for the assumed W_TO_max.
                new_W_TO = obj.newton(W_AminusW_initial,V_MO_initial);
        
        function new_W = newton(obj,W_AminusW_initial,V_MO_initial)
            [lift_dist, moment_dist] = obj.loadsFunc(obj.W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            
            % [W_TO_calc, W_ZF_calc] = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
            W_fuel_calc = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_calc = W_AminusW_initial+W_fuel_calc+obj.wingDesign.W_fuel;
            W_ZF_calc = W_AminusW_initial+W_fuel_calc;
            f_x = obj.W_TO_max - W_TO_calc;
    
           
            d_W_calc_d_W = obj.W_TO_max_prime(W_AminusW_initial,V_MO_initial);
        function derivative =  W_TO_max_prime(obj, W_AminusW_initial,V_MO_initial)
            delta_W = 1;
            W_TO_plus = obj.W_TO_max+delta_W;
            [lift_distribution_plus, moment_distribution_plus] = obj.loadsFunc(W_TO_plus,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            W_wing_plus = obj.structuresFunc(lift_distribution_plus, moment_distribution_plus, W_TO_plus, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_max_plus = W_AminusW_initial+W_wing_plus+obj.wingDesign.W_fuel;
            
            % [W_TO_max_plus, ~] = obj.structuresFunc(lift_distribution_plus, moment_distribution_plus, W_TO_plus, obj.W_ZF);
            derivative = (W_TO_max_plus - obj.W_TO_max) / delta_W;
        end
        
            f_prime_x = 1 - d_W_calc_d_W;
        
            if abs(f_prime_x) > 1e-6 % Check for near-zero derivative
                new_W = obj.W_TO_max - (f_x / f_prime_x);
            end
        end
                
                % Update the assumed weight (W_TO_max) with the new, calculated value for the next iteration
                [new_lift_dist, new_moment_dist] = obj.loadsFunc(new_W_TO,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
                % [new_W_TO, new_ZF] = obj.structuresFunc(new_lift_dist, new_moment_dist, W_TO_max, W_ZF);
                new_W_wing = obj.structuresFunc(new_lift_dist, new_moment_dist, W_TO_max, W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
                new_W_TO = W_AminusW_initial+new_W_wing+obj.wingDesign.W_fuel;
                new_ZF = W_AminusW_initial+new_W_wing;
                
                obj.W_TO_max = new_W_TO;
                obj.W_ZF = new_ZF;
                % Optional: display the iteration progress
                % fprintf('Iteration: W_TO_assumed = %.2f, W_TO_new = %.2f, Difference = %.2f\n', W_TO_old, new_W_TO, abs(W_TO_old - new_W_TO));
            end
            [lift_dist, moment_dist] = obj.loadsFunc(obj.W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            % [W_TO_final, W_ZF_final] = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
            W_wing_final = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_final = W_AminusW_initial+W_wing_final+obj.wingDesign.W_fuel;
            W_ZF_final = W_AminusW_initial+W_wing_final;
            obj.W_TO_max = W_TO_final;
            obj.W_ZF = W_ZF_final;
            % fprintf('Finished Iterating: W_TO_initial = %.2f, W_TO_final = %.2f, Difference = %.2f\n', W_init, W_TO_final, abs(W_init - W_TO_final));

        end
            LD_cr = obj.aerodynamicsFunc(obj.mda.W_TO_max,obj.wingDesign.W_fuel);

        function [LD_cruise] = aerodynamicsFunc(obj,W_TO_max,W_fuel)
            [CL_wing, CD_wing] = obj.calcCL_CD(W_TO_max,W_fuel);
        function [CL_wing,CD_wing] = calcCL_CD(obj,W_TO_max,W_fuel)
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 1;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 30;
            % Flight Condition
            AC.Aero.V     = obj.wingDesign.V;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = obj.wingDesign.Re;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = obj.wingDesign.Mcr;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_cruise(W_TO_max,W_fuel);          % lift coefficient - comment this line to run the code for given alpha%
            % logMessage([string(datetime('now')) + " | AC details: " + jsonencode(AC)], "log.file");

            Res = Q3D_solver(AC);
            CL_wing = Res.CLwing;
            CD_wing = Res.CDwing;
            if isnan(CD_wing)
            end
            % logMessage([string(datetime('now')) + " | AC details: " + jsonencode(AC) + " | CL: " + string(CL_wing) + " | CD: " + string(CD_wing)], "log.file");
            % disp("CL_wing = " + string(CL_wing) + ", CD_wing = " + string(CD_wing));
            

        end

            q=obj.calculateDesignDynamicPressure();
        function q = calculateDesignDynamicPressure(obj)
            q=0.5*obj.wingDesign.rho*obj.wingDesign.V^2;
        end
            drag = CD_wing * q *obj.wingDesign.S + obj.initializer.drag_fus_initial/obj.initializer.q_design_initial * q;
            lift = CL_wing * q *obj.wingDesign.S;
            
            LD_cruise = lift/drag;

        end
            eta = obj.performanceFunction();
        function eta = performanceFunction(obj)
            A = (obj.wingDesign.V-obj.initializer.V_cr_ref_initial)^2/(2*70^2);
            B = (obj.wingDesign.hcr - Const.hcr_ref)^2/(2*2500^2);
            eta = exp(-A-B);
            
        end
            objective = obj.objectiveFunc(obj.wingDesign.W_fuel, obj.mda.W_TO_max, LD_cr, eta);
        function objective = objectiveFunc(obj,W_fuel, W_TO_max, LD_cr, eta)
            W_cr_ratio = 1/((W_fuel/W_TO_max-1)/-0.9938);
            CT = Const.CT_bar/eta;
            R = obj.wingDesign.V /CT *LD_cr *log(W_cr_ratio);
            objective = R;
            msg = [
                "Ran objective function that resulted in range = " + string(R)
                "With designVector:"
                obj.dvec.toString()  % column string array
            ];
            
            % logMessage(msg, "log.file");
        end
                     

        end
            logmsg("--------------------------------");
            logmsg("At " + string(datetime('now')) + ...
                " calculated range: " + string(range/1000) + " km");
            logmsg("With wing design:");
            logmsg(obj.wingDesign.toString());
            logmsg("--------------------------------");
            objective = -(range/obj.initializer.range_initial);
        end
        function [c,ceq] = constraints(obj,x_normalized)
            x=x_normalized.*obj.x0;
            obj.dvec = obj.dvec.fromVector(x);
            obj.wingDesign = obj.wingDesign.fromDesignVector(obj.dvec);
            obj.mda.wingDesign = obj.wingDesign;

            
            % No inequality constraints
            lol =obj.mda.MDA_loop(obj.mda.W_TO_max,obj.wingDesign.W_fuel,obj.mda.W_ZF,obj.initializer.W_AminusW_initial,obj.initializer.V_MO_initial);

        function obj= MDA_loop(obj,W_TO_max,W_fuel,W_ZF,W_AminusW_initial,V_MO_initial)
            
            W_init = W_TO_max;
            obj.W_TO_max = W_TO_max;
            % obj.W_fuel = W_fuel;
            obj.W_ZF = W_ZF;
            
            [lift_dist, moment_dist] = obj.loadsFunc(W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            W_wing = obj.structuresFunc(lift_dist, moment_dist, W_TO_max, W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            obj.W_TO_max = W_AminusW_initial+W_wing+obj.wingDesign.W_fuel;
            obj.W_ZF = W_AminusW_initial+W_wing;

            W_TO_old = 0;
            while abs(obj.W_TO_max - W_TO_old) > W_TO_old * 0.01
    
                % Store the current assumed weight before iteration for the convergence check
                W_TO_old = obj.W_TO_max;
                
                % Perform one step of the Newton-Raphson iteration to get a better estimate
                % The 'newton' function already calculates W_TO_calculated for the assumed W_TO_max.
                new_W_TO = obj.newton(W_AminusW_initial,V_MO_initial);
        
        function new_W = newton(obj,W_AminusW_initial,V_MO_initial)
            [lift_dist, moment_dist] = obj.loadsFunc(obj.W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            
            % [W_TO_calc, W_ZF_calc] = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
            W_fuel_calc = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_calc = W_AminusW_initial+W_fuel_calc+obj.wingDesign.W_fuel;
            W_ZF_calc = W_AminusW_initial+W_fuel_calc;
            f_x = obj.W_TO_max - W_TO_calc;
    
           
            d_W_calc_d_W = obj.W_TO_max_prime(W_AminusW_initial,V_MO_initial);
        function derivative =  W_TO_max_prime(obj, W_AminusW_initial,V_MO_initial)
            delta_W = 1;
            W_TO_plus = obj.W_TO_max+delta_W;
            [lift_distribution_plus, moment_distribution_plus] = obj.loadsFunc(W_TO_plus,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            W_wing_plus = obj.structuresFunc(lift_distribution_plus, moment_distribution_plus, W_TO_plus, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_max_plus = W_AminusW_initial+W_wing_plus+obj.wingDesign.W_fuel;
            
            % [W_TO_max_plus, ~] = obj.structuresFunc(lift_distribution_plus, moment_distribution_plus, W_TO_plus, obj.W_ZF);
            derivative = (W_TO_max_plus - obj.W_TO_max) / delta_W;
        end
        
            f_prime_x = 1 - d_W_calc_d_W;
        
            if abs(f_prime_x) > 1e-6 % Check for near-zero derivative
                new_W = obj.W_TO_max - (f_x / f_prime_x);
            end
        end
                
                % Update the assumed weight (W_TO_max) with the new, calculated value for the next iteration
                [new_lift_dist, new_moment_dist] = obj.loadsFunc(new_W_TO,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
                % [new_W_TO, new_ZF] = obj.structuresFunc(new_lift_dist, new_moment_dist, W_TO_max, W_ZF);
                new_W_wing = obj.structuresFunc(new_lift_dist, new_moment_dist, W_TO_max, W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
                new_W_TO = W_AminusW_initial+new_W_wing+obj.wingDesign.W_fuel;
                new_ZF = W_AminusW_initial+new_W_wing;
                
                obj.W_TO_max = new_W_TO;
                obj.W_ZF = new_ZF;
                % Optional: display the iteration progress
                % fprintf('Iteration: W_TO_assumed = %.2f, W_TO_new = %.2f, Difference = %.2f\n', W_TO_old, new_W_TO, abs(W_TO_old - new_W_TO));
            end
            [lift_dist, moment_dist] = obj.loadsFunc(obj.W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            % [W_TO_final, W_ZF_final] = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
            W_wing_final = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_final = W_AminusW_initial+W_wing_final+obj.wingDesign.W_fuel;
            W_ZF_final = W_AminusW_initial+W_wing_final;
            obj.W_TO_max = W_TO_final;
            obj.W_ZF = W_ZF_final;
            % fprintf('Finished Iterating: W_TO_initial = %.2f, W_TO_final = %.2f, Difference = %.2f\n', W_init, W_TO_final, abs(W_init - W_TO_final));

        end
            c(1) = obj.mda.W_TO_max/obj.wingDesign.S  - Const.W_TO_max_initial/obj.initializer.S_initial; % Wing loading constraint  
            ceq = [];
        end
    end
end
        function objective = objective_wrapper(obj,x_normalized)
            x=x_normalized.*obj.x0;
            obj.dvec = obj.dvec.fromVector(x);
            obj.wingDesign = obj.wingDesign.fromDesignVector(obj.dvec);
            obj.mda.wingDesign = obj.wingDesign;
            % obj.dvec = DesignVector().fromVector(x);
            % obj.wingDesign = WingDesign(obj.dvec);
            % obj.mda.wingDesign = obj.wingDesign;
            range = obj.objective_loop();
        function objective = objective_loop(obj)
            lol =obj.mda.MDA_loop(obj.mda.W_TO_max,obj.wingDesign.W_fuel,obj.mda.W_ZF,obj.initializer.W_AminusW_initial,obj.initializer.V_MO_initial);

        function obj= MDA_loop(obj,W_TO_max,W_fuel,W_ZF,W_AminusW_initial,V_MO_initial)
            
            W_init = W_TO_max;
            obj.W_TO_max = W_TO_max;
            % obj.W_fuel = W_fuel;
            obj.W_ZF = W_ZF;
            
            [lift_dist, moment_dist] = obj.loadsFunc(W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            W_wing = obj.structuresFunc(lift_dist, moment_dist, W_TO_max, W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            obj.W_TO_max = W_AminusW_initial+W_wing+obj.wingDesign.W_fuel;
            obj.W_ZF = W_AminusW_initial+W_wing;

            W_TO_old = 0;
            while abs(obj.W_TO_max - W_TO_old) > W_TO_old * 0.01
    
                % Store the current assumed weight before iteration for the convergence check
                W_TO_old = obj.W_TO_max;
                
                % Perform one step of the Newton-Raphson iteration to get a better estimate
                % The 'newton' function already calculates W_TO_calculated for the assumed W_TO_max.
                new_W_TO = obj.newton(W_AminusW_initial,V_MO_initial);
        
        function new_W = newton(obj,W_AminusW_initial,V_MO_initial)
            [lift_dist, moment_dist] = obj.loadsFunc(obj.W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            
            % [W_TO_calc, W_ZF_calc] = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
            W_fuel_calc = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_calc = W_AminusW_initial+W_fuel_calc+obj.wingDesign.W_fuel;
            W_ZF_calc = W_AminusW_initial+W_fuel_calc;
            f_x = obj.W_TO_max - W_TO_calc;
    
           
            d_W_calc_d_W = obj.W_TO_max_prime(W_AminusW_initial,V_MO_initial);
        function derivative =  W_TO_max_prime(obj, W_AminusW_initial,V_MO_initial)
            delta_W = 1;
            W_TO_plus = obj.W_TO_max+delta_W;
            [lift_distribution_plus, moment_distribution_plus] = obj.loadsFunc(W_TO_plus,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            W_wing_plus = obj.structuresFunc(lift_distribution_plus, moment_distribution_plus, W_TO_plus, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_max_plus = W_AminusW_initial+W_wing_plus+obj.wingDesign.W_fuel;
            
            % [W_TO_max_plus, ~] = obj.structuresFunc(lift_distribution_plus, moment_distribution_plus, W_TO_plus, obj.W_ZF);
            derivative = (W_TO_max_plus - obj.W_TO_max) / delta_W;
        end
        
            f_prime_x = 1 - d_W_calc_d_W;
        
            if abs(f_prime_x) > 1e-6 % Check for near-zero derivative
                new_W = obj.W_TO_max - (f_x / f_prime_x);
            end
        end
                
                % Update the assumed weight (W_TO_max) with the new, calculated value for the next iteration
                [new_lift_dist, new_moment_dist] = obj.loadsFunc(new_W_TO,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
                % [new_W_TO, new_ZF] = obj.structuresFunc(new_lift_dist, new_moment_dist, W_TO_max, W_ZF);
                new_W_wing = obj.structuresFunc(new_lift_dist, new_moment_dist, W_TO_max, W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
                new_W_TO = W_AminusW_initial+new_W_wing+obj.wingDesign.W_fuel;
                new_ZF = W_AminusW_initial+new_W_wing;
                
                obj.W_TO_max = new_W_TO;
                obj.W_ZF = new_ZF;
                % Optional: display the iteration progress
                % fprintf('Iteration: W_TO_assumed = %.2f, W_TO_new = %.2f, Difference = %.2f\n', W_TO_old, new_W_TO, abs(W_TO_old - new_W_TO));
            end
            [lift_dist, moment_dist] = obj.loadsFunc(obj.W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            % [W_TO_final, W_ZF_final] = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
            W_wing_final = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_final = W_AminusW_initial+W_wing_final+obj.wingDesign.W_fuel;
            W_ZF_final = W_AminusW_initial+W_wing_final;
            obj.W_TO_max = W_TO_final;
            obj.W_ZF = W_ZF_final;
            % fprintf('Finished Iterating: W_TO_initial = %.2f, W_TO_final = %.2f, Difference = %.2f\n', W_init, W_TO_final, abs(W_init - W_TO_final));

        end
            LD_cr = obj.aerodynamicsFunc(obj.mda.W_TO_max,obj.wingDesign.W_fuel);

        function [LD_cruise] = aerodynamicsFunc(obj,W_TO_max,W_fuel)
            [CL_wing, CD_wing] = obj.calcCL_CD(W_TO_max,W_fuel);
        function [CL_wing,CD_wing] = calcCL_CD(obj,W_TO_max,W_fuel)
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 1;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 30;
            % Flight Condition
            AC.Aero.V     = obj.wingDesign.V;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = obj.wingDesign.Re;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = obj.wingDesign.Mcr;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_cruise(W_TO_max,W_fuel);          % lift coefficient - comment this line to run the code for given alpha%
            % logMessage([string(datetime('now')) + " | AC details: " + jsonencode(AC)], "log.file");

            Res = Q3D_solver(AC);
            CL_wing = Res.CLwing;
            CD_wing = Res.CDwing;
            if isnan(CD_wing)
            end
            % logMessage([string(datetime('now')) + " | AC details: " + jsonencode(AC) + " | CL: " + string(CL_wing) + " | CD: " + string(CD_wing)], "log.file");
            % disp("CL_wing = " + string(CL_wing) + ", CD_wing = " + string(CD_wing));
            

        end

            q=obj.calculateDesignDynamicPressure();
        function q = calculateDesignDynamicPressure(obj)
            q=0.5*obj.wingDesign.rho*obj.wingDesign.V^2;
        end
            drag = CD_wing * q *obj.wingDesign.S + obj.initializer.drag_fus_initial/obj.initializer.q_design_initial * q;
            lift = CL_wing * q *obj.wingDesign.S;
            
            LD_cruise = lift/drag;

        end
            eta = obj.performanceFunction();
        function eta = performanceFunction(obj)
            A = (obj.wingDesign.V-obj.initializer.V_cr_ref_initial)^2/(2*70^2);
            B = (obj.wingDesign.hcr - Const.hcr_ref)^2/(2*2500^2);
            eta = exp(-A-B);
            
        end
            objective = obj.objectiveFunc(obj.wingDesign.W_fuel, obj.mda.W_TO_max, LD_cr, eta);
        function objective = objectiveFunc(obj,W_fuel, W_TO_max, LD_cr, eta)
            W_cr_ratio = 1/((W_fuel/W_TO_max-1)/-0.9938);
            CT = Const.CT_bar/eta;
            R = obj.wingDesign.V /CT *LD_cr *log(W_cr_ratio);
            objective = R;
            msg = [
                "Ran objective function that resulted in range = " + string(R)
                "With designVector:"
                obj.dvec.toString()  % column string array
            ];
            
            % logMessage(msg, "log.file");
        end
                     

        end
            logmsg("--------------------------------");
            logmsg("At " + string(datetime('now')) + ...
                " calculated range: " + string(range/1000) + " km");
            logmsg("With wing design:");
            logmsg(obj.wingDesign.toString());
            logmsg("--------------------------------");
            objective = -(range/obj.initializer.range_initial);
        end
        function [c,ceq] = constraints(obj,x_normalized)
            x=x_normalized.*obj.x0;
            obj.dvec = obj.dvec.fromVector(x);
            obj.wingDesign = obj.wingDesign.fromDesignVector(obj.dvec);
            obj.mda.wingDesign = obj.wingDesign;

            
            % No inequality constraints
            lol =obj.mda.MDA_loop(obj.mda.W_TO_max,obj.wingDesign.W_fuel,obj.mda.W_ZF,obj.initializer.W_AminusW_initial,obj.initializer.V_MO_initial);

        function obj= MDA_loop(obj,W_TO_max,W_fuel,W_ZF,W_AminusW_initial,V_MO_initial)
            
            W_init = W_TO_max;
            obj.W_TO_max = W_TO_max;
            % obj.W_fuel = W_fuel;
            obj.W_ZF = W_ZF;
            
            [lift_dist, moment_dist] = obj.loadsFunc(W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            W_wing = obj.structuresFunc(lift_dist, moment_dist, W_TO_max, W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            obj.W_TO_max = W_AminusW_initial+W_wing+obj.wingDesign.W_fuel;
            obj.W_ZF = W_AminusW_initial+W_wing;

            W_TO_old = 0;
            while abs(obj.W_TO_max - W_TO_old) > W_TO_old * 0.01
    
                % Store the current assumed weight before iteration for the convergence check
                W_TO_old = obj.W_TO_max;
                
                % Perform one step of the Newton-Raphson iteration to get a better estimate
                % The 'newton' function already calculates W_TO_calculated for the assumed W_TO_max.
                new_W_TO = obj.newton(W_AminusW_initial,V_MO_initial);
        
        function new_W = newton(obj,W_AminusW_initial,V_MO_initial)
            [lift_dist, moment_dist] = obj.loadsFunc(obj.W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            
            % [W_TO_calc, W_ZF_calc] = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
            W_fuel_calc = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_calc = W_AminusW_initial+W_fuel_calc+obj.wingDesign.W_fuel;
            W_ZF_calc = W_AminusW_initial+W_fuel_calc;
            f_x = obj.W_TO_max - W_TO_calc;
    
           
            d_W_calc_d_W = obj.W_TO_max_prime(W_AminusW_initial,V_MO_initial);
        function derivative =  W_TO_max_prime(obj, W_AminusW_initial,V_MO_initial)
            delta_W = 1;
            W_TO_plus = obj.W_TO_max+delta_W;
            [lift_distribution_plus, moment_distribution_plus] = obj.loadsFunc(W_TO_plus,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            W_wing_plus = obj.structuresFunc(lift_distribution_plus, moment_distribution_plus, W_TO_plus, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_max_plus = W_AminusW_initial+W_wing_plus+obj.wingDesign.W_fuel;
            
            % [W_TO_max_plus, ~] = obj.structuresFunc(lift_distribution_plus, moment_distribution_plus, W_TO_plus, obj.W_ZF);
            derivative = (W_TO_max_plus - obj.W_TO_max) / delta_W;
        end
        
            f_prime_x = 1 - d_W_calc_d_W;
        
            if abs(f_prime_x) > 1e-6 % Check for near-zero derivative
                new_W = obj.W_TO_max - (f_x / f_prime_x);
            end
        end
                
                % Update the assumed weight (W_TO_max) with the new, calculated value for the next iteration
                [new_lift_dist, new_moment_dist] = obj.loadsFunc(new_W_TO,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
                % [new_W_TO, new_ZF] = obj.structuresFunc(new_lift_dist, new_moment_dist, W_TO_max, W_ZF);
                new_W_wing = obj.structuresFunc(new_lift_dist, new_moment_dist, W_TO_max, W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
                new_W_TO = W_AminusW_initial+new_W_wing+obj.wingDesign.W_fuel;
                new_ZF = W_AminusW_initial+new_W_wing;
                
                obj.W_TO_max = new_W_TO;
                obj.W_ZF = new_ZF;
                % Optional: display the iteration progress
                % fprintf('Iteration: W_TO_assumed = %.2f, W_TO_new = %.2f, Difference = %.2f\n', W_TO_old, new_W_TO, abs(W_TO_old - new_W_TO));
            end
            [lift_dist, moment_dist] = obj.loadsFunc(obj.W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            % [W_TO_final, W_ZF_final] = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
            W_wing_final = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_final = W_AminusW_initial+W_wing_final+obj.wingDesign.W_fuel;
            W_ZF_final = W_AminusW_initial+W_wing_final;
            obj.W_TO_max = W_TO_final;
            obj.W_ZF = W_ZF_final;
            % fprintf('Finished Iterating: W_TO_initial = %.2f, W_TO_final = %.2f, Difference = %.2f\n', W_init, W_TO_final, abs(W_init - W_TO_final));

        end
            c(1) = obj.mda.W_TO_max/obj.wingDesign.S  - Const.W_TO_max_initial/obj.initializer.S_initial; % Wing loading constraint  
            ceq = [];
        end
    end
end
        function objective = objective_wrapper(obj,x_normalized)
            x=x_normalized.*obj.x0;
            obj.dvec = obj.dvec.fromVector(x);
            obj.wingDesign = obj.wingDesign.fromDesignVector(obj.dvec);
            obj.mda.wingDesign = obj.wingDesign;
            % obj.dvec = DesignVector().fromVector(x);
            % obj.wingDesign = WingDesign(obj.dvec);
            % obj.mda.wingDesign = obj.wingDesign;
            range = obj.objective_loop();
        function objective = objective_loop(obj)
            lol =obj.mda.MDA_loop(obj.mda.W_TO_max,obj.wingDesign.W_fuel,obj.mda.W_ZF,obj.initializer.W_AminusW_initial,obj.initializer.V_MO_initial);

        function obj= MDA_loop(obj,W_TO_max,W_fuel,W_ZF,W_AminusW_initial,V_MO_initial)
            
            W_init = W_TO_max;
            obj.W_TO_max = W_TO_max;
            % obj.W_fuel = W_fuel;
            obj.W_ZF = W_ZF;
            
            [lift_dist, moment_dist] = obj.loadsFunc(W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            W_wing = obj.structuresFunc(lift_dist, moment_dist, W_TO_max, W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            obj.W_TO_max = W_AminusW_initial+W_wing+obj.wingDesign.W_fuel;
            obj.W_ZF = W_AminusW_initial+W_wing;

            W_TO_old = 0;
            while abs(obj.W_TO_max - W_TO_old) > W_TO_old * 0.01
    
                % Store the current assumed weight before iteration for the convergence check
                W_TO_old = obj.W_TO_max;
                
                % Perform one step of the Newton-Raphson iteration to get a better estimate
                % The 'newton' function already calculates W_TO_calculated for the assumed W_TO_max.
                new_W_TO = obj.newton(W_AminusW_initial,V_MO_initial);
        
        function new_W = newton(obj,W_AminusW_initial,V_MO_initial)
            [lift_dist, moment_dist] = obj.loadsFunc(obj.W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            
            % [W_TO_calc, W_ZF_calc] = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
            W_fuel_calc = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_calc = W_AminusW_initial+W_fuel_calc+obj.wingDesign.W_fuel;
            W_ZF_calc = W_AminusW_initial+W_fuel_calc;
            f_x = obj.W_TO_max - W_TO_calc;
    
           
            d_W_calc_d_W = obj.W_TO_max_prime(W_AminusW_initial,V_MO_initial);
        function derivative =  W_TO_max_prime(obj, W_AminusW_initial,V_MO_initial)
            delta_W = 1;
            W_TO_plus = obj.W_TO_max+delta_W;
            [lift_distribution_plus, moment_distribution_plus] = obj.loadsFunc(W_TO_plus,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            W_wing_plus = obj.structuresFunc(lift_distribution_plus, moment_distribution_plus, W_TO_plus, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_max_plus = W_AminusW_initial+W_wing_plus+obj.wingDesign.W_fuel;
            
            % [W_TO_max_plus, ~] = obj.structuresFunc(lift_distribution_plus, moment_distribution_plus, W_TO_plus, obj.W_ZF);
            derivative = (W_TO_max_plus - obj.W_TO_max) / delta_W;
        end
        
            f_prime_x = 1 - d_W_calc_d_W;
        
            if abs(f_prime_x) > 1e-6 % Check for near-zero derivative
                new_W = obj.W_TO_max - (f_x / f_prime_x);
            end
        end
                
                % Update the assumed weight (W_TO_max) with the new, calculated value for the next iteration
                [new_lift_dist, new_moment_dist] = obj.loadsFunc(new_W_TO,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
                % [new_W_TO, new_ZF] = obj.structuresFunc(new_lift_dist, new_moment_dist, W_TO_max, W_ZF);
                new_W_wing = obj.structuresFunc(new_lift_dist, new_moment_dist, W_TO_max, W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
                new_W_TO = W_AminusW_initial+new_W_wing+obj.wingDesign.W_fuel;
                new_ZF = W_AminusW_initial+new_W_wing;
                
                obj.W_TO_max = new_W_TO;
                obj.W_ZF = new_ZF;
                % Optional: display the iteration progress
                % fprintf('Iteration: W_TO_assumed = %.2f, W_TO_new = %.2f, Difference = %.2f\n', W_TO_old, new_W_TO, abs(W_TO_old - new_W_TO));
            end
            [lift_dist, moment_dist] = obj.loadsFunc(obj.W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            % [W_TO_final, W_ZF_final] = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
            W_wing_final = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_final = W_AminusW_initial+W_wing_final+obj.wingDesign.W_fuel;
            W_ZF_final = W_AminusW_initial+W_wing_final;
            obj.W_TO_max = W_TO_final;
            obj.W_ZF = W_ZF_final;
            % fprintf('Finished Iterating: W_TO_initial = %.2f, W_TO_final = %.2f, Difference = %.2f\n', W_init, W_TO_final, abs(W_init - W_TO_final));

        end
            LD_cr = obj.aerodynamicsFunc(obj.mda.W_TO_max,obj.wingDesign.W_fuel);

        function [LD_cruise] = aerodynamicsFunc(obj,W_TO_max,W_fuel)
            [CL_wing, CD_wing] = obj.calcCL_CD(W_TO_max,W_fuel);
        function [CL_wing,CD_wing] = calcCL_CD(obj,W_TO_max,W_fuel)
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 1;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 30;
            % Flight Condition
            AC.Aero.V     = obj.wingDesign.V;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = obj.wingDesign.Re;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = obj.wingDesign.Mcr;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_cruise(W_TO_max,W_fuel);          % lift coefficient - comment this line to run the code for given alpha%
            % logMessage([string(datetime('now')) + " | AC details: " + jsonencode(AC)], "log.file");

            Res = Q3D_solver(AC);
 Iter  Func-count            Fval   Feasibility   Step Length       Norm of   First-order  
                                                                       step    optimality
    0          13    2.200316e-01     0.000e+00     1.000e+00     0.000e+00     3.198e-01  
    1          26    3.744274e-02     0.000e+00     1.000e+00     5.646e-01     6.729e-02  
    2          39    2.346186e-02     0.000e+00     1.000e+00     1.641e-01     3.615e-02  
    3          52    1.814172e-02     0.000e+00     1.000e+00     1.333e-01     2.754e-02  
    4          65    1.590373e-02     0.000e+00     1.000e+00     8.493e-02     2.009e-02  
    5          78    1.196618e-02     0.000e+00     1.000e+00     1.836e-01     2.505e-02  
    6          91    6.809911e-03     0.000e+00     1.000e+00     2.993e-01     2.831e-02  
    7         104    2.619601e-03     0.000e+00     1.000e+00     3.106e-01     2.009e-02  
    8         117    1.186949e-03     0.000e+00     1.000e+00     1.231e-01     9.542e-03  
    9         130    8.940961e-04     0.000e+00     1.000e+00     2.826e-02     4.726e-03  
   10         143    7.553996e-04     0.000e+00     1.000e+00     2.369e-02     4.859e-03  
   11         156    6.145664e-04     0.000e+00     1.000e+00     3.147e-02     4.148e-03  
   12         169    5.568162e-04     0.000e+00     1.000e+00     2.343e-02     1.617e-03  
   13         182    5.461595e-04     0.000e+00     1.000e+00     1.134e-02     5.692e-04  
   14         195    5.441955e-04     0.000e+00     1.000e+00     3.559e-03     6.730e-04  
   15         208    5.408401e-04     0.000e+00     1.000e+00     5.437e-03     7.879e-04  
   16         221    5.323797e-04     0.000e+00     1.000e+00     1.366e-02     1.185e-03  
   17         234    5.131763e-04     0.000e+00     1.000e+00     3.295e-02     1.953e-03  
   18         247    4.766032e-04     0.000e+00     1.000e+00     6.867e-02     2.651e-03  
   19         260    4.302260e-04     0.000e+00     1.000e+00     9.827e-02     2.662e-03  
   20         273    4.007411e-04     0.000e+00     1.000e+00     6.913e-02     1.573e-03  
   21         286    3.931314e-04     0.000e+00     1.000e+00     1.209e-02     5.924e-04  
   22         299    3.917517e-04     0.000e+00     1.000e+00     8.126e-03     4.694e-04  
   23         312    3.903767e-04     0.000e+00     1.000e+00     7.087e-03     5.117e-04  
   24         325    3.863018e-04     0.000e+00     1.000e+00     1.298e-02     8.056e-04  
   25         338    3.765514e-04     0.000e+00     1.000e+00     2.261e-02     1.238e-03  
   26         351    3.521439e-04     0.000e+00     1.000e+00     5.722e-02     1.872e-03  
   27         364    2.989850e-04     0.000e+00     1.000e+00     1.432e-01     2.590e-03  
   28         377    2.071508e-04     0.000e+00     1.000e+00     2.924e-01     3.048e-03  
   29         390    1.108958e-04     0.000e+00     1.000e+00     3.738e-01     2.401e-03  
 Iter  Func-count            Fval   Feasibility   Step Length       Norm of   First-order  
                                                                       step    optimality
   30         403    6.582120e-05     0.000e+00     1.000e+00     2.073e-01     9.181e-04  
   31         416    5.854512e-05     0.000e+00     1.000e+00     3.017e-02     1.175e-04  
   32         429    5.819365e-05     0.000e+00     1.000e+00     2.211e-02     4.781e-06  
   33         442    5.818897e-05     0.000e+00     1.000e+00     3.774e-03     1.079e-06  
   34         455    5.818896e-05     0.000e+00     1.000e+00     1.738e-04     6.146e-08  
   35         468    5.818896e-05     0.000e+00     1.000e+00     1.625e-06     3.202e-08  
   36         481    5.818896e-05     0.000e+00     1.000e+00     2.689e-07     3.141e-08  
   37         494    5.818896e-05     0.000e+00     1.000e+00     8.769e-07     3.108e-08  
   38         507    5.818896e-05     0.000e+00     1.000e+00     8.098e-07     2.095e-08  
   39         520    5.818896e-05     0.000e+00     1.000e+00     5.809e-07     1.166e-08  
   40         533    5.818896e-05     0.000e+00     1.000e+00     3.405e-07     6.507e-09  
   41         546    5.818896e-05     0.000e+00     1.000e+00     8.627e-08     6.085e-09  
   42         559    5.818896e-05     0.000e+00     1.000e+00     1.857e-08     5.108e-09  
   43         572    5.818896e-05     0.000e+00     1.000e+00     1.366e-08     4.304e-09  
   44         585    5.818896e-05     0.000e+00     1.000e+00     1.240e-08     3.628e-09  
   45         598    5.818896e-05     0.000e+00     1.000e+00     1.026e-08     3.063e-09  
   46         611    5.818896e-05     0.000e+00     1.000e+00     1.230e-08     2.588e-09  
   47         624    5.818896e-05     0.000e+00     1.000e+00     9.658e-09     2.177e-09  
   48         637    5.818896e-05     0.000e+00     1.000e+00     1.762e-08     1.843e-09  
   49         650    5.818896e-05     0.000e+00     1.000e+00     8.350e-09     1.556e-09  
   50         663    5.818896e-05     0.000e+00     1.000e+00     3.949e-09     1.310e-09  
   51         676    5.818896e-05     0.000e+00     1.000e+00     8.510e-09     1.114e-09  
   52         694    5.818896e-05     0.000e+00     1.681e-01     2.001e-09     1.083e-09  
   53         707    5.818896e-05     0.000e+00     1.000e+00     8.191e-09     9.195e-10  
   54         720    5.818896e-05     0.000e+00     1.000e+00     3.998e-09     7.908e-10  
   55         733    5.818896e-05     0.000e+00     1.000e+00     2.745e-09     6.994e-10  
   56         746    5.818896e-05     0.000e+00     1.000e+00     1.800e-09     6.321e-10  
   57         759    5.818896e-05     0.000e+00     1.000e+00     3.916e-09     5.639e-10  
   58         772    5.818896e-05     0.000e+00     1.000e+00     1.761e-09     5.170e-10  
   59         785    5.818896e-05     0.000e+00     1.000e+00     6.135e-09     4.652e-10  
 Iter  Func-count            Fval   Feasibility   Step Length       Norm of   First-order  
                                                                       step    optimality
   60         805    5.818896e-05     0.000e+00     8.235e-02     2.468e-10     4.620e-10  
   61         836    5.818896e-05     0.000e+00     1.628e-03     1.321e-11     4.648e-10  
   62         849    5.818896e-05     0.000e+00     1.000e+00     1.491e-09     4.297e-10  
   63         874    5.818896e-05     0.000e+00     1.384e-02     1.107e-10     4.266e-10  
   64         899    5.818896e-05     0.000e+00     1.341e-04     1.616e-12     4.266e-10  

Optimization stopped because the <a href = "matlab: helpview('optim','norm_curr_step_fminconip','CSHelpWindow');">relative changes in all elements of x</a> are
less than <a href = "matlab: helpview('optim','tolx','CSHelpWindow');">options.StepTolerance</a> = 1.000000e-12, and the relative maximum constraint
violation, 0.000000e+00, is less than <a href = "matlab: helpview('optim','tol_con','CSHelpWindow');">options.ConstraintTolerance</a> = 1.000000e-06.

classdef Optimizer < handle
    properties
        mda MDA
        dvec DesignVector
        wingDesign WingDesign
        initializer Initializer
        x0
        x_normalizer
    end
    
    methods
        function obj = Optimizer(dvec, wingDesign,initializer)
            obj.dvec =dvec;
            obj.x0 = obj.dvec.toVector();
            obj.wingDesign = wingDesign;
            obj.initializer = initializer;
            obj.mda = MDA(obj.wingDesign,Const.W_TO_max_initial,obj.initializer.W_ZF_initial);
classdef MDA < handle
    properties
        wingDesign WingDesign
        W_ZF
        W_TO_max
    end
    
    methods
        
        function obj = MDA(wingDesign,W_TO_max, W_ZF)
            arguments
                wingDesign WingDesign
                W_TO_max
                W_ZF
            end
            obj.wingDesign = wingDesign ;
            obj.W_TO_max = W_TO_max;
            obj.W_ZF = W_ZF;
        end
        end
        function [CL_wing,CD_wing] = calcCL_CD(obj,W_TO_max,W_fuel)
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 1;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 30;
            % Flight Condition
            AC.Aero.V     = obj.wingDesign.V;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = obj.wingDesign.Re;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = obj.wingDesign.Mcr;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_cruise(W_TO_max,W_fuel);          % lift coefficient - comment this line to run the code for given alpha%
            % logMessage([string(datetime('now')) + " | AC details: " + jsonencode(AC)], "log.file");

            Res = Q3D_solver(AC);
            CL_wing = Res.CLwing;
            CD_wing = Res.CDwing;
            if isnan(CD_wing)
            end
            % logMessage([string(datetime('now')) + " | AC details: " + jsonencode(AC) + " | CL: " + string(CL_wing) + " | CD: " + string(CD_wing)], "log.file");
            % disp("CL_wing = " + string(CL_wing) + ", CD_wing = " + string(CD_wing));
            

        end
        function q = calculateDesignDynamicPressure(obj)
            q=0.5*obj.wingDesign.rho*obj.wingDesign.V^2;
        end

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
Intersection occurred at ratio of 0.084168
Intersection occurred at ratio of 2.2445
        function objective = objective_loop(obj)
            lol =obj.mda.MDA_loop(obj.mda.W_TO_max,obj.wingDesign.W_fuel,obj.mda.W_ZF,obj.initializer.W_AminusW_initial,obj.initializer.V_MO_initial);

        function obj= MDA_loop(obj,W_TO_max,W_fuel,W_ZF,W_AminusW_initial,V_MO_initial)
            
            W_init = W_TO_max;
            obj.W_TO_max = W_TO_max;
            % obj.W_fuel = W_fuel;
            obj.W_ZF = W_ZF;
            
            [lift_dist, moment_dist] = obj.loadsFunc(W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            W_wing = obj.structuresFunc(lift_dist, moment_dist, W_TO_max, W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            obj.W_TO_max = W_AminusW_initial+W_wing+obj.wingDesign.W_fuel;
            obj.W_ZF = W_AminusW_initial+W_wing;

            W_TO_old = 0;
            while abs(obj.W_TO_max - W_TO_old) > W_TO_old * 0.01
    
                % Store the current assumed weight before iteration for the convergence check
                W_TO_old = obj.W_TO_max;
                
                % Perform one step of the Newton-Raphson iteration to get a better estimate
                % The 'newton' function already calculates W_TO_calculated for the assumed W_TO_max.
                new_W_TO = obj.newton(W_AminusW_initial,V_MO_initial);
        
        function new_W = newton(obj,W_AminusW_initial,V_MO_initial)
            [lift_dist, moment_dist] = obj.loadsFunc(obj.W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            
            % [W_TO_calc, W_ZF_calc] = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
            W_fuel_calc = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_calc = W_AminusW_initial+W_fuel_calc+obj.wingDesign.W_fuel;
            W_ZF_calc = W_AminusW_initial+W_fuel_calc;
            f_x = obj.W_TO_max - W_TO_calc;
    
           
            d_W_calc_d_W = obj.W_TO_max_prime(W_AminusW_initial,V_MO_initial);
        function derivative =  W_TO_max_prime(obj, W_AminusW_initial,V_MO_initial)
            delta_W = 1;
            W_TO_plus = obj.W_TO_max+delta_W;
            [lift_distribution_plus, moment_distribution_plus] = obj.loadsFunc(W_TO_plus,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            W_wing_plus = obj.structuresFunc(lift_distribution_plus, moment_distribution_plus, W_TO_plus, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_max_plus = W_AminusW_initial+W_wing_plus+obj.wingDesign.W_fuel;
            
            % [W_TO_max_plus, ~] = obj.structuresFunc(lift_distribution_plus, moment_distribution_plus, W_TO_plus, obj.W_ZF);
            derivative = (W_TO_max_plus - obj.W_TO_max) / delta_W;
        end
        
            f_prime_x = 1 - d_W_calc_d_W;
        
            if abs(f_prime_x) > 1e-6 % Check for near-zero derivative
                new_W = obj.W_TO_max - (f_x / f_prime_x);
            end
        end
                
                % Update the assumed weight (W_TO_max) with the new, calculated value for the next iteration
                [new_lift_dist, new_moment_dist] = obj.loadsFunc(new_W_TO,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
                % [new_W_TO, new_ZF] = obj.structuresFunc(new_lift_dist, new_moment_dist, W_TO_max, W_ZF);
                new_W_wing = obj.structuresFunc(new_lift_dist, new_moment_dist, W_TO_max, W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
                new_W_TO = W_AminusW_initial+new_W_wing+obj.wingDesign.W_fuel;
                new_ZF = W_AminusW_initial+new_W_wing;
                
                obj.W_TO_max = new_W_TO;
                obj.W_ZF = new_ZF;
                % Optional: display the iteration progress
                % fprintf('Iteration: W_TO_assumed = %.2f, W_TO_new = %.2f, Difference = %.2f\n', W_TO_old, new_W_TO, abs(W_TO_old - new_W_TO));
            end
            [lift_dist, moment_dist] = obj.loadsFunc(obj.W_TO_max,V_MO_initial);

        function [lift_distribution, moment_distribution] = loadsFunc(obj, W_TO_max, V_MO_initial)
                        
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 0;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 150;
            % Flight Condition
            [rho_dont_use,a,T_dont_use] = obj.wingDesign.isa_func();
            Mcritical = V_MO_initial/a;
            Re_corrected = obj.wingDesign.Re/V_MO_initial*obj.wingDesign.V;
            AC.Aero.V     = V_MO_initial;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = Re_corrected;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = Mcritical;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_critical(W_TO_max,V_MO_initial);          % lift coefficient - comment this line to run the code for given alpha%
            % AC.Aero.Alpha = 2;             % angle of attack -  comment this line to run the code for given cl 

            % tic
            
            % try 
            % disp("Starting Q3D");
            Res = Q3D_solver(AC);
            % disp("Finished Q3D");
            % disp("CL: "+string(AC.Aero.CL))
            % toc
            y     = Res.Wing.Yst(:);          
            cl    = Res.Wing.cl(:);          
            cm    = Res.Wing.cm_c4(:);       
            chord = Res.Wing.chord(:);   
                
            rho = AC.Aero.rho;
            V   = AC.Aero.V;

            lift_distribution.y = y;
            lift_distribution.L = 0.5 * rho * V^2 * chord.*cl;
            moment_distribution.y = y;
            moment_distribution.M = 0.5 * rho * V^2 * chord .* chord .*cm;

            lift_distribution.y = [0;lift_distribution.y; obj.wingDesign.b_half];
            lift_distribution.L = [lift_distribution.L(1);lift_distribution.L;0];

            moment_distribution.y = [0;moment_distribution.y; obj.wingDesign.b_half];
            moment_distribution.M = [moment_distribution.M(1);moment_distribution.M;0];

            L_total = 2 * trapz(lift_distribution.y, lift_distribution.L);
            M_total = 2 * trapz(moment_distribution.y, moment_distribution.M);
                
            % if AC.Visc ==1
            %     disp("Drag Coefficient: "+string(Res.CDwing));
            % end
            % disp("Total lift [N]: "+string(L_total));
            % disp("Cruise lift [N]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2));
            % disp("Cruise lift [kg]: "+string(AC.Aero.CL*0.5*rho*V^2*obj.wingDesign.S*2/9.81));
            % disp("Total moment in Nm"+string(M_total));
        
              
        end
            % [W_TO_final, W_ZF_final] = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
            W_wing_final = obj.structuresFunc(lift_dist, moment_dist, obj.W_TO_max, obj.W_ZF);
        function W_wing = structuresFunc(obj, lift_distribution, moment_distribution, W_TO_max, W_ZF)
            fileName = "optimizing";
            N1 = 0.5;
            N2 = 1;
            %% Create .loading File
            fid = fopen(fileName+'.load', 'w');
        
            if fid == -1
            end
            for i = 1:length(lift_distribution.y)
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                    fprintf(fid, "%.6f %.6f %.6f\n", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
                % disp(string(lift_distribution.y(i)) + " " + string(lift_distribution.L(i)) + " " + string(moment_distribution.M(i)));
        
                % write the line to file
                if i < length(lift_distribution.y)
                else
                    fprintf(fid, "%.6f %.6f %.6f", lift_distribution.y(i)/obj.wingDesign.b_half, lift_distribution.L(i), moment_distribution.M(i));
                end
            end
            fclose(fid);

            
            points_per_side = 36;
            ts = linspace(0,1,points_per_side+1);
            
            
            
            t_upper = flip(ts);     
            t_upper = t_upper(1:end-1);
            y_upper = CST(t_upper, obj.wingDesign.AU);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            
            % Lower surface
            t_lower = ts;
            y_lower = CST(t_lower, obj.wingDesign.AL);
            %% Create .dat File
            function result = CST(t,A)
                cn = t.^N1 .* (1-t).^N2;
                s = 0;
                for i = 0:5
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                    s = s + nchoosek(5,i) * t.^i .* (1-t).^(5-i) .* A(i+1);
                end
                result = cn .* s;
            end
            % Calculate upper surface points using a similar approach
            

            fid = fopen('airfoil.dat', 'w');

            if fid == -1
            end
            for index = 1:length(t_upper)
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
                t = t_upper(index);
                y = y_upper(index);
                fprintf(fid, string(t)+" "+string(y)+"\n");
            end
            for index = 1:length(t_lower)
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                    fprintf(fid, string(t)+" "+string(y)+"\n");
                end
            end
                t = t_lower(index);
                y = y_lower(index);
                if index < length(t_lower)
                else
                    fprintf(fid, string(t)+" "+string(y));
                end
            end
            
            fclose(fid);
            
            %% Create .init File
            fid = fopen(fileName+'.init', 'w');

            if fid == -1
            end
            
            fprintf(fid, string(round(W_TO_max))+" "+string(round(W_ZF))+"\n");
            fprintf(fid, string(Const.n_max)+"\n");
            fprintf(fid, "%.2f %.2f %d %d\n", obj.wingDesign.S, obj.wingDesign.b_half*2, obj.wingDesign.number_of_platforms, obj.wingDesign.number_of_airfoils);
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_root/obj.wingDesign.b_half, 'airfoil');
            fprintf(fid, "%.2f %s\n", obj.wingDesign.y_tip/obj.wingDesign.b_half, 'airfoil');
            
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_root, obj.wingDesign.x_root, obj.wingDesign.y_root, obj.wingDesign.z_root, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_kink, obj.wingDesign.x_kink, obj.wingDesign.y_kink, obj.wingDesign.z_kink, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
            fprintf(fid, "%.4f %.4f %.4f %.4f %.4f %.4f\n", ...
            obj.wingDesign.c_tip, obj.wingDesign.x_tip, obj.wingDesign.y_tip, obj.wingDesign.z_tip, obj.wingDesign.front_spar_pos,obj.wingDesign.rear_spar_pos);
        
            fprintf(fid, "%.4f %.4f\n", obj.wingDesign.start_tank, obj.wingDesign.end_tank);
            fprintf(fid, "%d\n", obj.wingDesign.engine_each_wing);
            fprintf(fid, "%.4f %d\n",obj.wingDesign.engine_location/obj.wingDesign.b_half, obj.wingDesign.engine_weight);
        
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            fprintf(fid, "%.5e %.2f %.5e %.5e\n", obj.wingDesign.E_mod, obj.wingDesign.density, obj.wingDesign.tensile_yield, obj.wingDesign.compressive_yield);
            
            fprintf(fid, "%.2f %.2f\n", obj.wingDesign.efficiency_factor, obj.wingDesign.rib_pitch);
            fprintf(fid, "%d", 0);
        
            fclose(fid);
            
            EMWET optimizing;
            
            fid = fopen(fileName+'.weight','r');  % replace with your file name

            if fid == -1
            end
            
            % Read the first line
            firstLine = fgetl(fid);
            
            % Close the file
            fclose(fid);
            
            % Extract the number from the line using regexp
            massStr = regexp(firstLine, '\d+\.?\d*', 'match');  % match numeric values
            wing_mass = str2double(massStr{1});                 % convert to double
            % disp("wing mass: "+string(wing_mass))
            % disp(obj.wingDesign.LE_sweep*180/pi)
            
            W_wing = wing_mass;
        end
    end
end
            W_TO_final = W_AminusW_initial+W_wing_final+obj.wingDesign.W_fuel;
            W_ZF_final = W_AminusW_initial+W_wing_final;
            obj.W_TO_max = W_TO_final;
            obj.W_ZF = W_ZF_final;
            % fprintf('Finished Iterating: W_TO_initial = %.2f, W_TO_final = %.2f, Difference = %.2f\n', W_init, W_TO_final, abs(W_init - W_TO_final));

        end
            LD_cr = obj.aerodynamicsFunc(obj.mda.W_TO_max,obj.wingDesign.W_fuel);

        function [LD_cruise] = aerodynamicsFunc(obj,W_TO_max,W_fuel)
            [CL_wing, CD_wing] = obj.calcCL_CD(W_TO_max,W_fuel);
        function [CL_wing,CD_wing] = calcCL_CD(obj,W_TO_max,W_fuel)
            % Wing planform geometry 
            %               x    y     z   chord(m)    twist angle (deg) 
            AC.Wing.Geom = [obj.wingDesign.x_root     obj.wingDesign.y_root     obj.wingDesign.z_root     obj.wingDesign.c_root         obj.wingDesign.twist(1)
                            obj.wingDesign.x_kink     obj.wingDesign.y_kink     obj.wingDesign.z_kink     obj.wingDesign.c_kink         obj.wingDesign.twist(2)
                            obj.wingDesign.x_tip     obj.wingDesign.y_tip     obj.wingDesign.z_tip     obj.wingDesign.c_tip        obj.wingDesign.twist(3)];

            % Wing incidence angle (degree)
            AC.Wing.inc  = obj.wingDesign.incidence;   
                        
                        
            % Airfoil coefficients input matrix
            %                    | ->     upper curve coeff.                <-|   | ->       lower curve coeff.       <-| 
            AC.Wing.Airfoils   = [obj.wingDesign.AU obj.wingDesign.AL;
                                  obj.wingDesign.AU obj.wingDesign.AL];
                              
            %AC.Wing.eta = [obj.wingDesign.y_root/obj.wingDesign.b_half;obj.wingDesign.y_kink/obj.wingDesign.b_half;obj.wingDesign.y_tip/obj.wingDesign.b_half];  % Spanwise location of the airfoil sections
            AC.Wing.eta = [0;1];
            % Viscous vs inviscid
            AC.Visc  = 1;              % 0 for inviscid and 1 for viscous analysis
            AC.Aero.MaxIterIndex = 30;
            % Flight Condition
            AC.Aero.V     = obj.wingDesign.V;            % flight speed (m/s)
            AC.Aero.rho   = obj.wingDesign.rho;         % air density  (kg/m3)
            AC.Aero.alt   = obj.wingDesign.hcr;             % flight altitude (m)
            AC.Aero.Re    = obj.wingDesign.Re;        % reynolds number (bqased on mean aerodynamic chord)
            AC.Aero.M     = obj.wingDesign.Mcr;           % flight Mach number 
            AC.Aero.CL    = obj.wingDesign.calculateCL_cruise(W_TO_max,W_fuel);          % lift coefficient - comment this line to run the code for given alpha%
            % logMessage([string(datetime('now')) + " | AC details: " + jsonencode(AC)], "log.file");

            Res = Q3D_solver(AC);
            CL_wing = Res.CLwing;
            CD_wing = Res.CDwing;
            if isnan(CD_wing)
            end
            % logMessage([string(datetime('now')) + " | AC details: " + jsonencode(AC) + " | CL: " + string(CL_wing) + " | CD: " + string(CD_wing)], "log.file");
            % disp("CL_wing = " + string(CL_wing) + ", CD_wing = " + string(CD_wing));
            

        end

            q=obj.calculateDesignDynamicPressure();
        function q = calculateDesignDynamicPressure(obj)
            q=0.5*obj.wingDesign.rho*obj.wingDesign.V^2;
        end
            drag = CD_wing * q *obj.wingDesign.S + obj.initializer.drag_fus_initial/obj.initializer.q_design_initial * q;
            lift = CL_wing * q *obj.wingDesign.S;
            
            LD_cruise = lift/drag;

        end
            eta = obj.performanceFunction();
        function eta = performanceFunction(obj)
            A = (obj.wingDesign.V-obj.initializer.V_cr_ref_initial)^2/(2*70^2);
            B = (obj.wingDesign.hcr - Const.hcr_ref)^2/(2*2500^2);
            eta = exp(-A-B);
            
        end
            objective = obj.objectiveFunc(obj.wingDesign.W_fuel, obj.mda.W_TO_max, LD_cr, eta);
        function objective = objectiveFunc(obj,W_fuel, W_TO_max, LD_cr, eta)
            W_cr_ratio = 1/((W_fuel/W_TO_max-1)/-0.9938);
            CT = Const.CT_bar/eta;
            R = obj.wingDesign.V /CT *LD_cr *log(W_cr_ratio);
            objective = R;
            msg = [
                "Ran objective function that resulted in range = " + string(R)
                "With designVector:"
                obj.dvec.toString()  % column string array
            ];
            
            % logMessage(msg, "log.file");
        end
                     

        end
Initial range equals: -5612.65 km
